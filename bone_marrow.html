<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bone Marrow Counter</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 10px;
      background: #f0f2f5;
    }

    h2, p {
      text-align: center;
    }

    .progress-container {
      background: #ddd;
      border-radius: 10px;
      overflow: hidden;
      height: 20px;
      margin: 15px auto;
      width: 90%;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background-color: #4caf50;
      border-radius: 10px;
      transition: width 0.4s ease, background-color 0.4s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: bold;
    }

    .counter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .cell-counter {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 15px;
      text-align: center;
      transition: transform 0.2s ease;
    }

    .cell-counter:hover {
      transform: translateY(-5px);
    }

    .cell-image {
      width: 70px;
      height: 70px;
      object-fit: contain;
      margin-bottom: 8px;
      cursor: pointer;
    }

    .normal-range {
      display: none;
      font-size: 12px;
      color: gray;
      margin-top: 4px;
    }

    .button-row, .nav-back {
      text-align: center;
      margin: 20px 0;
    }

    button {
      background-color: #007bff;
      color: white;
      padding: 10px 20px;
      font-size: 14px;
      border: none;
      border-radius: 5px;
      margin: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #0056b3;
    }

    .total-count-display {
      font-weight: bold;
      font-size: 18px;
      margin: 10px 0;
    }

    .nav-back a {
      text-decoration: none;
      color: #007bff;
      font-weight: bold;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    table, th, td {
      border: 1px solid #ddd;
    }

    th, td {
      padding: 10px;
      text-align: center;
    }

    th {
      background-color: #f2f2f2;
    }

    /* Mobile Friendly */
    @media (max-width: 768px) {
      button {
        font-size: 12px;
        padding: 8px 16px;
      }
      .cell-image {
        width: 60px;
        height: 60px;
      }
    }

    @media (max-width: 480px) {
      .counter-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>

<body>

<h2>Bone Marrow Counter</h2>
<p><strong>Counting Limit: 500 cells</strong></p>

<div class="progress-container">
  <div class="progress-bar" id="progressBar">0%</div>
</div>

<p class="total-count-display">Total Cells: <span id="totalCount">0</span> / 500</p>

<div class="button-row">
  <button onclick="toggleNormalValues()">Show/Hide Normal Ranges</button>
</div>

<div class="counter-grid" id="counterGrid"></div>

<div class="button-row">
  <button onclick="resetCounts()">Reset</button>
  <button onclick="calculatePercentages()">Calculate</button>
  <button onclick="exportToPDF()">Export to PDF</button>
</div>

<div id="results"></div>

<div class="nav-back"><a href="./index.html">Back to Menu</a></div>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
  const cellTypes = {
    erythroblast: "Erythroblast",
    dyserythroblast: "Dyserythroblast",
    myeloblast: "Myeloblast",
    promyelocyte: "Promyelocyte",
    myelocyte: "Myelocyte",
    metamyelocyte: "Metamyelocyte",
    band: "Band Form",
    neutrophil: "Neutrophil",
    eosinophil: "Eosinophil",
    basophil: "Basophil",
    monoblast: "Monoblast",
    monocyte: "Monocyte",
    lymphocyte: "Lymphocyte",
    plasma: "Plasma Cell",
    megakaryoblast: "Megakaryoblast",
    megakaryocyte: "Megakaryocyte",
    others: "Others"
  };

  const erythroidCells = ['erythroblast', 'dyserythroblast'];
  const myeloidCells = ['myeloblast', 'promyelocyte', 'myelocyte', 'metamyelocyte', 'band', 'neutrophil', 'eosinophil', 'basophil', 'monoblast', 'monocyte'];

  function createCounters() {
    const grid = document.getElementById("counterGrid");
    for (const key in cellTypes) {
      const div = document.createElement("div");
      div.className = "cell-counter";
      div.innerHTML = `
        <img src="images/${key}.png" alt="${cellTypes[key]}" onclick="increment('${key}')" class="cell-image">
        <p>${cellTypes[key]}: <span id="${key}">0</span></p>
        <div class="normal-range">Normal range not defined</div>
      `;
      grid.appendChild(div);
    }
  }

  function increment(cellType) {
    const total = getTotalCount();
    if (total >= 500) {
      alert("You have reached the limit of 500 cells.");
      return;
    }
    const el = document.getElementById(cellType);
    el.innerText = parseInt(el.innerText) + 1;
    document.getElementById('totalCount').innerText = getTotalCount();
    updateProgressBar();
  }

  function getTotalCount() {
    return Object.keys(cellTypes).reduce((sum, cell) => {
      return sum + parseInt(document.getElementById(cell).innerText);
    }, 0);
  }

  function resetCounts() {
    for (const cell in cellTypes) {
      document.getElementById(cell).innerText = '0';
    }
    document.getElementById('results').innerHTML = '';
    document.getElementById('totalCount').innerText = '0';
    updateProgressBar();
  }

  function calculatePercentages() {
    const total = getTotalCount();
    if (total === 0) {
      alert("No cells counted yet.");
      return;
    }

    let resultHTML = "<h3>Bone Marrow Differential (Normalized to 100%)</h3>";
    resultHTML += "<table><tr><th>Cell Type</th><th>Count</th><th>%</th></tr>";

    let erythroidCount = 0, myeloidCount = 0;

    for (const cell in cellTypes) {
      const count = parseInt(document.getElementById(cell).innerText);
      const percent = ((count / total) * 100).toFixed(2);
      resultHTML += `<tr><td>${cellTypes[cell]}</td><td>${count}</td><td>${percent}%</td></tr>`;
      if (erythroidCells.includes(cell)) erythroidCount += count;
      if (myeloidCells.includes(cell)) myeloidCount += count;
    }

    resultHTML += "</table><br>";

    const ratio = erythroidCount === 0 ? "∞" : (myeloidCount / erythroidCount).toFixed(2);
    resultHTML += `<p><strong>Myeloid:Erythroid Ratio:</strong> ${ratio}</p>`;
    resultHTML += `<p><strong>Normal M:E Ratio:</strong> 2:1 to 4:1</p>`;

    document.getElementById('results').innerHTML = resultHTML;
  }

  function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text("Bone Marrow Differential (Normalized to 100%)", 10, 10);

    let y = 20;
    const total = getTotalCount();
    let erythroid = 0, myeloid = 0;

    for (const cell in cellTypes) {
      const count = parseInt(document.getElementById(cell).innerText);
      const percent = ((count / total) * 100).toFixed(2);
      doc.text(`${cellTypes[cell]}: ${count} (${percent}%)`, 10, y);
      if (erythroidCells.includes(cell)) erythroid += count;
      if (myeloidCells.includes(cell)) myeloid += count;
      y += 8;
    }

    y += 5;
    const ratio = erythroid === 0 ? "∞" : (myeloid / erythroid).toFixed(2);
    doc.text(`Myeloid:Erythroid Ratio: ${ratio}`, 10, y);
    y += 8;
    doc.text("Normal M:E Ratio: 2:1 to 4:1", 10, y);

    doc.save("bone_marrow_differential.pdf");
  }

  function toggleNormalValues() {
    const normals = document.querySelectorAll('.normal-range');
    normals.forEach(n => {
      n.style.display = (n.style.display === 'none' || n.style.display === '') ? 'block' : 'none';
    });
  }

  function updateProgressBar() {
    const total = getTotalCount();
    const percent = (total / 500) * 100;
    const progressBar = document.getElementById('progressBar');

    progressBar.style.width = percent + "%";
    progressBar.textContent = Math.round(percent) + "%";

    if (percent < 60) {
      progressBar.style.backgroundColor = '#4caf50'; // Green
    } else if (percent < 90) {
      progressBar.style.backgroundColor = '#ffc107'; // Yellow/Orange
    } else {
      progressBar.style.backgroundColor = '#dc3545'; // Red
    }
  }

  createCounters();
</script>

</body>
</html>
