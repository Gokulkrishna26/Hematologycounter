<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>WBC Counter</title>
  <style>
    /* Your original styles go here */

    /* Progress Bar */
    #progressBarContainer {
      width: 100%;
      background-color: #f3f3f3;
      height: 20px;
      border-radius: 10px;
      position: relative;
    }
    #progressBar {
      height: 100%;
      width: 0%;
      background-color: green;
      border-radius: 10px;
      transition: width 0.5s ease;
    }
    #progressText {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      color: white;
      font-weight: bold;
    }
  </style>
</head>

<body>

<h2>WBC Counter</h2>
<p><strong>Counting Limit: 100 cells</strong></p>
<p class="total-count-display">Total Cells: <span id="totalCount">0</span> / 100</p>

<!-- Progress Bar -->
<div id="progressBarContainer">
  <div id="progressBar"></div>
  <span id="progressText">0%</span>
</div>

<div class="counter-grid" id="counterGrid">
  <!-- Cells will be inserted dynamically -->
</div>

<div class="button-row">
  <button onclick="resetCounts()">Reset</button>
  <button onclick="calculatePercentages()">Calculate</button>
  <button onclick="exportToPDF()">Export to PDF</button>
</div>

<div id="results"></div>

<div class="nav-back"><a href="./index.html">Back to Menu</a></div>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/haptics.js/1.1.1/haptics.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
  const cellTypes = {
    neutrophil: "Neutrophil",
    lymphocyte: "Lymphocyte",
    monocyte: "Monocyte",
    eosinophil: "Eosinophil",
    basophil: "Basophil",
    others: "Others"
  };

  function createCounters() {
    const grid = document.getElementById("counterGrid");
    for (const key in cellTypes) {
        const cellName = cellTypes[key];
        const div = document.createElement("div");
        div.className = "cell-counter";
        div.innerHTML = `
        <img src="images/${key}.png" alt="${cellName}" onclick="increment('${key}')" class="cell-image">
        <p>${cellName}: <span id="${key}">0</span></p>
      `;
        grid.appendChild(div);
    }
  }

  function increment(cellType) {
    const total = getTotalCount();
    if (total >= 100) {
        alert("You have reached the total limit of 100 cells.");
        return;
    }
    const el = document.getElementById(cellType);
    el.innerText = parseInt(el.innerText) + 1;
    document.getElementById('totalCount').innerText = getTotalCount();
    updateProgressBar();
    hapticFeedback();
  }

  function hapticFeedback() {
    if (navigator.vibrate) {
        navigator.vibrate(50); 
    }
  }

  function getTotalCount() {
    return Object.keys(cellTypes).reduce((sum, cell) => {
        return sum + parseInt(document.getElementById(cell).innerText);
    }, 0);
  }

  function resetCounts() {
    for (const cell in cellTypes) {
        document.getElementById(cell).innerText = '0';
    }
    document.getElementById('results').innerHTML = '';
    document.getElementById('totalCount').innerText = '0';
    updateProgressBar(); 
  }

  function calculatePercentages() {
    const total = getTotalCount();
    if (total === 0) {
        alert("No cells counted.");
        return;
    }

    let resultHTML = "<h3>WBC Differential (Normalized to 100%)</h3>";
    resultHTML += "<table><tr><th>Cell Type</th><th>Count</th><th>%</th></tr>";

    for (const cell in cellTypes) {
        const count = parseInt(document.getElementById(cell).innerText);
        const percent = ((count / total) * 100).toFixed(2);
        resultHTML += `<tr><td>${cellTypes[cell]}</td><td>${count}</td><td>${percent}%</td></tr>`;
    }

    resultHTML += "</table>";

    document.getElementById('results').innerHTML = resultHTML;
  }

  function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text("WBC Differential (Normalized to 100%)", 10, 10);

    let y = 20;
    const total = getTotalCount();

    for (const cell in cellTypes) {
        const count = parseInt(document.getElementById(cell).innerText);
        const percent = ((count / total) * 100).toFixed(2);
        doc.text(`${cellTypes[cell]}: ${count} (${percent}%)`, 10, y);
        y += 10;
    }

    doc.save("wbc_report.pdf");
  }

  function updateProgressBar() {
    const total = getTotalCount();
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const percentage = (total / 100) * 100;

    progressBar.style.width = `${percentage}%`;

    if (percentage <= 33) {
        progressBar.style.backgroundColor = 'green';
    } else if (percentage <= 66) {
        progressBar.style.backgroundColor = 'yellow';
    } else {
        progressBar.style.backgroundColor = 'red';
    }

    progressText.innerText = `${percentage.toFixed(0)}%`;
  }

  window.onload = function () {
    createCounters();
  };
</script>
</body>
</html>
